version: 2.1

orbs:
  path-filtering: circleci/path-filtering@1.2.0

setup: << pipeline.parameters.run-setup >>

parameters:
  run-setup:
    type: boolean
    default: true

  build_hypgames:
    type: boolean
    default: false

jobs:
  # Precompile all the rust dependencies
  compile:
    executor: nix-executor
    steps:
      - run: echo "compile job in rust-rep 123"
      
  test:
    executor: nix-executor
    steps:
      - run: echo "test job in rust-rep"

  staging:
    executor: nix-executor
    steps:
      - run: echo "staging job in rust-rep"

workflows:
  pre:
    when: << pipeline.parameters.run-setup >>
    jobs:
      - path-filtering/filter:
          base-revision: << pipeline.git.base_revision >>
          tag: '3.9.0'
          ## Config for continuation; herein we reuse this config itself
          config-path: .circleci/config.yml
          # 3-column space-separated table for mapping; `path-to-test parameter-to-set value-for-parameter` for each row
          mapping: |
            .* run-setup false
            server/.* build_hypgames true
            mobile/client/Assets/PoolPrototype/BallPoolGame/Game/Scripts/Mechanics/.* build_hypgames true
            devdash/.* build_hypgames true

  build:
    when: << pipeline.parameters.build_hypgames >>
    jobs:
      - test
      - compile
      - staging:
          requires:
            - compile
            - test
  
